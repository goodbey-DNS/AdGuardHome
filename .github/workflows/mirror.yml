name: é•œåƒå®˜æ–¹æœ€æ–°åŒ…ï¼ˆæœ€ç»ˆç‰ˆï¼‰

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      arch:
        description: 'æ¶æ„ï¼ˆamd64, arm64, armv6, armv7ï¼‰'
        required: false
        default: 'amd64'
      version:
        description: 'æŒ‡å®šç‰ˆæœ¬ï¼ˆç•™ç©ºåˆ™æœ€æ–°ï¼‰'
        required: false
        default: ''

concurrency:
  # ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªé•œåƒä»»åŠ¡åœ¨è¿è¡Œï¼Œé¿å…å‘å¸ƒå†²çª
  group: mirror-adguardhome
  cancel-in-progress: false # é˜Ÿåˆ—åŒ–æ‰§è¡Œï¼Œä¸ä¸­æ–­æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: write # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º/æ›´æ–° Release
    steps:
      - name: è·å–ç‰ˆæœ¬ä¸æ¶æ„
        id: v
        run: |
          set -e # ä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡ºï¼Œé˜²æ­¢é”™è¯¯æ‰©æ•£
          
          VER="${{ github.event.inputs.version }}"
          ARCH="${{ github.event.inputs.arch }}"
          
          # å¤„ç†ç‰ˆæœ¬ï¼šè‹¥æœªæŒ‡å®šåˆ™ä» GitHub API è·å–æœ€æ–°ç‰ˆ
          if [ -z "$VER" ]; then
            echo "æœªæŒ‡å®šç‰ˆæœ¬ï¼Œæ­£åœ¨ä» GitHub API è·å–æœ€æ–°ç‰ˆæœ¬..."
            # -f å‚æ•°è®© curl å¯¹ HTTP é”™è¯¯ç  (å¦‚ 404, 403) ä¹Ÿè¿”å›éé›¶é€€å‡ºç 
            API_RESPONSE=$(curl -sSf https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest)
            VER=$(echo "$API_RESPONSE" | jq -r .tag_name)
            
            # éªŒè¯è·å–åˆ°çš„ç‰ˆæœ¬å·æ˜¯å¦æœ‰æ•ˆ
            if [ -z "$VER" ] || [ "$VER" = "null" ]; then
              echo "::error::æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ŒAPI å“åº”æ— æ•ˆæˆ–ä»“åº“ç»“æ„å˜æ›´"
              exit 1
            fi
            echo "âœ… è·å–åˆ°æœ€æ–°ç‰ˆæœ¬: $VER"
          else
            echo "âœ… ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬: $VER"
          fi
          
          # å¤„ç†æ¶æ„ï¼šè‹¥æœªæŒ‡å®šåˆ™é»˜è®¤ amd64
          ARCH="${ARCH:-amd64}"
          
          # éªŒè¯æ¶æ„æ˜¯å¦æœ‰æ•ˆï¼Œé˜²æ­¢ç”¨æˆ·è¾“å…¥é”™è¯¯å¯¼è‡´ 404
          VALID_ARCHS=("amd64" "arm64" "armv6" "armv7")
          if [[ ! " ${VALID_ARCHS[*]} " =~ " ${ARCH} " ]]; then
            echo "::error::æ— æ•ˆçš„æ¶æ„: $ARCH"
            echo "æ”¯æŒçš„æ¶æ„ä¸º: ${VALID_ARCHS[*]}"
            exit 1
          fi
          echo "âœ… ä½¿ç”¨æ¶æ„: $ARCH"
          
          # å°†ç»“æœè¾“å‡ºç»™åç»­æ­¥éª¤ä½¿ç”¨
          echo "tag=$VER" >> $GITHUB_OUTPUT
          echo "arch=$ARCH" >> $GITHUB_OUTPUT

      - name: ä»å®˜æ–¹æºä¸‹è½½
        run: |
          set -e
          
          VER="${{ steps.v.outputs.tag }}"
          ARCH="${{ steps.v.outputs.arch }}"
          URL="https://github.com/AdguardTeam/AdGuardHome/releases/download/${VER}/AdGuardHome_linux_${ARCH}.tar.gz"
          
          echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½: $URL"
          wget --show-progress -O adguard.tar.gz "$URL"
          
          # éªŒè¯æ–‡ä»¶å·²æˆåŠŸä¸‹è½½ä¸”éç©º
          if [ ! -s adguard.tar.gz ]; then
            echo "::error::ä¸‹è½½å¤±è´¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼ˆå¯èƒ½ URL é”™è¯¯æˆ–ç½‘ç»œé—®é¢˜ï¼‰"
            exit 1
          fi
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å·²ä¿å­˜"

      - name: æ ¡éªŒæ–‡ä»¶å¤§å°ï¼ˆâ‰¥10 MBï¼‰
        run: |
          set -e
          
          # å†æ¬¡ç¡®è®¤æ–‡ä»¶å­˜åœ¨
          if [ ! -s adguard.tar.gz ]; then
            echo "::error::æ–‡ä»¶ adguard.tar.gz ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
          fi
          
          SIZE=$(stat -c%s adguard.tar.gz)
          MIN_SIZE=10000000 # 10MB
          
          # æ–‡ä»¶è¿‡å°é€šå¸¸æ„å‘³ç€ä¸‹è½½äº†é”™è¯¯é¡µé¢æˆ–å†…å®¹ä¸å®Œæ•´
          if [ "$SIZE" -lt "$MIN_SIZE" ]; then
            echo "::error::æ–‡ä»¶å¤§å°æ ¡éªŒå¤±è´¥ï¼š${SIZE} Bï¼ˆå°äº ${MIN_SIZE} Bï¼‰ï¼Œå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ AdGuard Home å®‰è£…åŒ…"
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶å¤§å°æ ¡éªŒé€šè¿‡: $(numfmt --to=iec-i $SIZE)"

      - name: æ¸…ç†æ—§ç‰ˆæœ¬èµ„äº§
        # æ­¤æ­¥éª¤åœ¨é¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½å›  'latest' Release ä¸å­˜åœ¨è€Œå¤±è´¥ï¼Œå› æ­¤å…è®¸é”™è¯¯ç»§ç»­æ‰§è¡Œ
        uses: mknejp/delete-release-assets@v1.0.1 # å›ºå®šç‰ˆæœ¬ä»¥ä¿è¯ç¨³å®šæ€§
        continue-on-error: true
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: latest
          assets: "*.tar.gz"

      - name: å‘å¸ƒåˆ° latest Release
        # ä½¿ç”¨ v2 ç‰ˆæœ¬ä»¥è·å¾—æ›´å¥½çš„æ›´æ–°æ”¯æŒå’Œç¨³å®šæ€§
        uses: softprops/action-gh-release@v2.0.8
        with:
          tag_name: latest
          name: "AdGuardHome ${{ steps.v.outputs.tag }} (${{ steps.v.outputs.arch }})"
          files: adguard.tar.gz
          body: |
            ğŸ“¦ **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ steps.v.outputs.tag }}
            ğŸ—ï¸ **æ¶æ„**: ${{ steps.v.outputs.arch }}
            â±ï¸ **å‘å¸ƒæ—¶é—´**: ${{ github.event.repository.updated_at }}
          make_latest: true # æ˜ç¡®å°†æ­¤ Release æ ‡è®°ä¸ºä»“åº“ä¸»é¡µçš„ "Latest release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
