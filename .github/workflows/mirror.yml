name: é•œåƒå®˜æ–¹æœ€æ–°åŒ…ï¼ˆæœ€ç»ˆç‰ˆï¼‰

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      arch:
        description: 'æ¶æ„ï¼ˆamd64, arm64, armv6, armv7ï¼‰'
        required: false
        default: 'amd64'
      version:
        description: 'æŒ‡å®šç‰ˆæœ¬ï¼ˆç•™ç©ºåˆ™æœ€æ–°ï¼‰'
        required: false
        default: ''

concurrency:
  group: mirror-adguardhome
  cancel-in-progress: false

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: è·å–ç‰ˆæœ¬ä¸æ¶æ„
        id: v
        run: |
          set -e
          
          VER="${{ github.event.inputs.version }}"
          ARCH="${{ github.event.inputs.arch }}"
          
          if [ -z "$VER" ]; then
            echo "æœªæŒ‡å®šç‰ˆæœ¬ï¼Œæ­£åœ¨ä» GitHub API è·å–æœ€æ–°ç‰ˆæœ¬..."
            API_RESPONSE=$(curl -sSf https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest)
            VER=$(echo "$API_RESPONSE" | jq -r .tag_name)
            
            if [ -z "$VER" ] || [ "$VER" = "null" ]; then
              echo "::error::æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯"
              exit 1
            fi
            echo "âœ… è·å–åˆ°æœ€æ–°ç‰ˆæœ¬: $VER"
          else
            echo "âœ… ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬: $VER"
          fi
          
          ARCH="${ARCH:-amd64}"
          VALID_ARCHS=("amd64" "arm64" "armv6" "armv7")
          if [[ ! " ${VALID_ARCHS[*]} " =~ " ${ARCH} " ]]; then
            echo "::error::æ— æ•ˆçš„æ¶æ„: $ARCH"
            echo "æ”¯æŒçš„æ¶æ„ä¸º: ${VALID_ARCHS[*]}"
            exit 1
          fi
          echo "âœ… ä½¿ç”¨æ¶æ„: $ARCH"
          
          echo "tag=$VER" >> $GITHUB_OUTPUT
          echo "arch=$ARCH" >> $GITHUB_OUTPUT

      - name: ä»å®˜æ–¹æºä¸‹è½½
        run: |
          set -e
          
          VER="${{ steps.v.outputs.tag }}"
          ARCH="${{ steps.v.outputs.arch }}"
          URL="https://github.com/AdguardTeam/AdGuardHome/releases/download/${VER}/AdGuardHome_linux_${ARCH}.tar.gz"
          
          echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½: $URL"
          wget --show-progress -O adguard.tar.gz "$URL"
          
          if [ ! -s adguard.tar.gz ]; then
            echo "::error::ä¸‹è½½å¤±è´¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
          fi
          echo "âœ… ä¸‹è½½å®Œæˆ"

      - name: æ ¡éªŒæ–‡ä»¶å¤§å°ï¼ˆâ‰¥10 MBï¼‰
        run: |
          set -e
          
          if [ ! -s adguard.tar.gz ]; then
            echo "::error::æ–‡ä»¶ adguard.tar.gz ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
          fi
          
          SIZE=$(stat -c%s adguard.tar.gz)
          MIN_SIZE=10000000
          
          if [ "$SIZE" -lt "$MIN_SIZE" ]; then
            echo "::error::æ–‡ä»¶å¤§å°æ ¡éªŒå¤±è´¥ï¼š${SIZE} Bï¼ˆå°äº ${MIN_SIZE} Bï¼‰"
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶å¤§å°æ ¡éªŒé€šè¿‡: $(numfmt --to=iec-i $SIZE)"

      - name: æ¸…ç†æ—§ç‰ˆæœ¬èµ„äº§
        uses: mknejp/delete-release-assets@v1.0.0  # â† ä¿®å¤ç‚¹ï¼šæ”¹ä¸º v1.0.0
        continue-on-error: true
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: latest
          assets: "*.tar.gz"

      - name: å‘å¸ƒåˆ° latest Release
        uses: softprops/action-gh-release@v2.0.8
        with:
          tag_name: latest
          name: "AdGuardHome ${{ steps.v.outputs.tag }} (${{ steps.v.outputs.arch }})"
          files: adguard.tar.gz
          body: |
            ğŸ“¦ **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ steps.v.outputs.tag }}
            ğŸ—ï¸ **æ¶æ„**: ${{ steps.v.outputs.arch }}
            â±ï¸ **å‘å¸ƒæ—¶é—´**: ${{ github.event.repository.updated_at }}
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
